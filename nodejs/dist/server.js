var $t=Object.defineProperty;var Lt=(e,t,r)=>t in e?$t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(Lt(e,typeof t!="symbol"?t+"":t,r),r),Me=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var f=(e,t,r)=>(Me(e,t,"read from private field"),r?r.call(e):t.get(e)),C=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},w=(e,t,r,s)=>(Me(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r);import{j as u,r as kt}from"./assets/streaming-DQs5bTwi.js";import{r as rt,s as Nt,e as We,c as Mt,F as Z,j as Ue,u as Wt,a as Ut,H as Ft,I as z}from"./assets/constants-6gU7-fjU.js";import{B as st,W as Jt}from"./assets/LatitudeIframe-1tbzXsvU.js";import{I as Fe,W as Kt}from"./assets/SignedParams-Dzp8Oa2c.js";var Bt=(e,...t)=>{const r=[""];for(let s=0,n=e.length-1;s<n;s++){r[0]+=e[s];const a=t[s]instanceof Array?t[s].flat(1/0):[t[s]];for(let i=0,c=a.length;i<c;i++){const o=a[i];if(typeof o=="string")We(o,r);else if(typeof o=="number")r[0]+=o;else{if(typeof o=="boolean"||o===null||o===void 0)continue;if(typeof o=="object"&&o.isEscaped)if(o.callbacks)r.unshift("",o);else{const d=o.toString();d instanceof Promise?r.unshift("",d):r[0]+=d}else o instanceof Promise?r.unshift("",o):We(o.toString(),r)}}}return r[0]+=e[e.length-1],r.length===1?rt(r[0]):Nt(r)};const qt=e=>e.render(u("h1",{children:"Sorry, Not Found..."})),zt=Object.freeze(Object.defineProperty({__proto__:null,default:qt},Symbol.toStringTag,{value:"Module"})),Vt=(e,t)=>t.render(u("h1",{children:["Error! ",e.message]})),Gt=Object.freeze(Object.defineProperty({__proto__:null,default:Vt},Symbol.toStringTag,{value:"Module"}));var nt=Mt(null),Xt=(e,t,r,s)=>(n,a)=>{const i=typeof(s==null?void 0:s.docType)=="string"?s.docType:(s==null?void 0:s.docType)===!1?"":"<!DOCTYPE html>",c=r?Ue(r,{Layout:t,...a},n):n,o=Bt`${rt(i)}${Ue(nt.Provider,{value:e},c)}`;if(s!=null&&s.stream){if(s.stream===!0)e.header("Transfer-Encoding","chunked"),e.header("Content-Type","text/html; charset=UTF-8");else for(const[d,l]of Object.entries(s.stream))e.header(d,l);return e.body(kt(o))}else return e.html(o)},Yt=(e,t)=>function(s,n){const a=s.getLayout()??Z;return e&&s.setLayout(i=>e({...i,Layout:a})),s.setRenderer(Xt(s,a,e,t)),n()},Qt=()=>{const e=Wt(nt);if(!e)throw new Error("RequestContext is not provided.");return e};const Zt=Yt(({children:e,title:t})=>u("html",{lang:"en",children:[u("head",{children:[u("meta",{charset:"utf-8"}),u("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),u("title",{children:t}),u("link",{rel:"icon",type:"image/x-icon",href:"/favicon.ico"}),u("link",{href:"/static/assets/style.css",rel:"stylesheet"}),u($s,{src:"/app/client.ts"})]}),u("body",{class:"bg-gray-50 dark:bg-gray-900 container mx-auto gap-y-4 p-6",children:u("main",{children:e})})]})),er=Object.freeze(Object.defineProperty({__proto__:null,default:Zt},Symbol.toStringTag,{value:"Module"}));var tr="text/plain; charset=UTF-8",ve=(e,t={})=>(Object.entries(t).forEach(([r,s])=>e.set(r,s)),e),Q,W,_,S,I,U,Ze,ge=(Ze=class{constructor(e,t){p(this,"req");p(this,"env",{});p(this,"_var",{});p(this,"finalized",!1);p(this,"error");C(this,Q,200);C(this,W,void 0);C(this,_,void 0);C(this,S,void 0);C(this,I,void 0);C(this,U,!0);p(this,"layout");p(this,"renderer",e=>this.html(e));p(this,"notFoundHandler",()=>new Response);p(this,"render",(...e)=>this.renderer(...e));p(this,"setLayout",e=>this.layout=e);p(this,"getLayout",()=>this.layout);p(this,"setRenderer",e=>{this.renderer=e});p(this,"header",(e,t,r)=>{if(t===void 0){f(this,_)?f(this,_).delete(e):f(this,S)&&delete f(this,S)[e.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(e);return}r!=null&&r.append?(f(this,_)||(w(this,U,!1),w(this,_,new Headers(f(this,S))),w(this,S,{})),f(this,_).append(e,t)):f(this,_)?f(this,_).set(e,t):(f(this,S)??w(this,S,{}),f(this,S)[e.toLowerCase()]=t),this.finalized&&(r!=null&&r.append?this.res.headers.append(e,t):this.res.headers.set(e,t))});p(this,"status",e=>{w(this,U,!1),w(this,Q,e)});p(this,"set",(e,t)=>{this._var??(this._var={}),this._var[e]=t});p(this,"get",e=>this._var?this._var[e]:void 0);p(this,"newResponse",(e,t,r)=>{if(f(this,U)&&!r&&!t&&f(this,Q)===200)return new Response(e,{headers:f(this,S)});if(t&&typeof t!="number"){const n=new Headers(t.headers);f(this,_)&&f(this,_).forEach((i,c)=>{n.set(c,i)});const a=ve(n,f(this,S));return new Response(e,{headers:a,status:t.status??f(this,Q)})}const s=typeof t=="number"?t:f(this,Q);f(this,S)??w(this,S,{}),f(this,_)??w(this,_,new Headers),ve(f(this,_),f(this,S)),f(this,I)&&(f(this,I).headers.forEach((n,a)=>{var i;(i=f(this,_))==null||i.set(a,n)}),ve(f(this,_),f(this,S))),r??(r={});for(const[n,a]of Object.entries(r))if(typeof a=="string")f(this,_).set(n,a);else{f(this,_).delete(n);for(const i of a)f(this,_).append(n,i)}return new Response(e,{status:s,headers:f(this,_)})});p(this,"body",(e,t,r)=>typeof t=="number"?this.newResponse(e,t,r):this.newResponse(e,t));p(this,"text",(e,t,r)=>{if(!f(this,S)){if(f(this,U)&&!r&&!t)return new Response(e);w(this,S,{})}return f(this,S)["content-type"]=tr,typeof t=="number"?this.newResponse(e,t,r):this.newResponse(e,t)});p(this,"json",(e,t,r)=>{const s=JSON.stringify(e);return f(this,S)??w(this,S,{}),f(this,S)["content-type"]="application/json; charset=UTF-8",typeof t=="number"?this.newResponse(s,t,r):this.newResponse(s,t)});p(this,"html",(e,t,r)=>(f(this,S)??w(this,S,{}),f(this,S)["content-type"]="text/html; charset=UTF-8",typeof e=="object"&&(e instanceof Promise||(e=e.toString()),e instanceof Promise)?e.then(s=>Ut(s,Ft.Stringify,!1,{})).then(s=>typeof t=="number"?this.newResponse(s,t,r):this.newResponse(s,t)):typeof t=="number"?this.newResponse(e,t,r):this.newResponse(e,t)));p(this,"redirect",(e,t=302)=>(f(this,_)??w(this,_,new Headers),f(this,_).set("Location",e),this.newResponse(null,t)));p(this,"notFound",()=>this.notFoundHandler(this));this.req=e,t&&(w(this,W,t.executionCtx),this.env=t.env,t.notFoundHandler&&(this.notFoundHandler=t.notFoundHandler))}get event(){if(f(this,W)&&"respondWith"in f(this,W))return f(this,W);throw Error("This context has no FetchEvent")}get executionCtx(){if(f(this,W))return f(this,W);throw Error("This context has no ExecutionContext")}get res(){return w(this,U,!1),f(this,I)||w(this,I,new Response("404 Not Found",{status:404}))}set res(e){if(w(this,U,!1),f(this,I)&&e){f(this,I).headers.delete("content-type");for(const[t,r]of f(this,I).headers.entries())if(t==="set-cookie"){const s=f(this,I).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}w(this,I,e),this.finalized=!0}get var(){return{...this._var}}},Q=new WeakMap,W=new WeakMap,_=new WeakMap,S=new WeakMap,I=new WeakMap,U=new WeakMap,Ze),Je=(e,t,r)=>(s,n)=>{let a=-1;return i(0);async function i(c){if(c<=a)throw new Error("next() called multiple times");a=c;let o,d=!1,l;if(e[c]?(l=e[c][0][0],s instanceof ge&&(s.req.routeIndex=c)):l=c===e.length&&n||void 0,!l)s instanceof ge&&s.finalized===!1&&r&&(o=await r(s));else try{o=await l(s,()=>i(c+1))}catch(h){if(h instanceof Error&&s instanceof ge&&t)s.error=h,o=await t(h,s),d=!0;else throw h}return o&&(s.finalized===!1||d)&&(s.res=o),s}},rr=class extends Error{constructor(t=500,r){super(r==null?void 0:r.message,{cause:r==null?void 0:r.cause});p(this,"res");p(this,"status");this.res=r==null?void 0:r.res,this.status=t}getResponse(){return this.res?this.res:new Response(this.message,{status:this.status})}},sr=async(e,t={all:!1})=>{const s=(e instanceof dt?e.raw.headers:e.headers).get("Content-Type");return nr(s)?ar(e,t):{}};function nr(e){return e===null?!1:e.startsWith("multipart/form-data")||e.startsWith("application/x-www-form-urlencoded")}async function ar(e,t){const r=await e.formData();return r?ir(r,t):{}}function ir(e,t){const r={};return e.forEach((s,n)=>{t.all||n.endsWith("[]")?or(r,n,s):r[n]=s}),r}var or=(e,t,r)=>{e[t]&&cr(e[t])?dr(e[t],r):e[t]?lr(e,t,r):e[t]=r};function cr(e){return Array.isArray(e)}var dr=(e,t)=>{e.push(t)},lr=(e,t,r)=>{e[t]=[e[t],r]},at=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},ur=e=>{const{groups:t,path:r}=hr(e),s=at(r);return fr(s,t)},hr=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{const n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},fr=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},me={},Ke=e=>{if(e==="*")return"*";const t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(me[e]||(t[2]?me[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:me[e]=[e,t[1],!0]),me[e]):null},it=e=>{const t=e.url,r=t.indexOf("?",8);return t.slice(t.indexOf("/",8),r===-1?void 0:r)},pr=e=>{const t=e.indexOf("?",8);return t===-1?"":"?"+e.slice(t+1)},mr=e=>{const t=it(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},ie=(...e)=>{let t="",r=!1;for(let s of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),r=!0),s[0]!=="/"&&(s=`/${s}`),s==="/"&&r?t=`${t}/`:s!=="/"&&(t=`${t}${s}`),s==="/"&&t===""&&(t="/");return t},ot=e=>{if(!e.match(/\:.+\?$/))return null;const t=e.split("/"),r=[];let s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);const a=n.replace("?","");s+="/"+a,r.push(s)}else s+="/"+n}),r.filter((n,a,i)=>i.indexOf(n)===a)},Re=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),/%/.test(e)?Ee(e):e):e,ct=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let i=e.indexOf(`?${t}`,8);for(i===-1&&(i=e.indexOf(`&${t}`,8));i!==-1;){const c=e.charCodeAt(i+t.length+1);if(c===61){const o=i+t.length+2,d=e.indexOf("&",o);return Re(e.slice(o,d===-1?void 0:d))}else if(c==38||isNaN(c))return"";i=e.indexOf(`&${t}`,i+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??(s=/[%+]/.test(e));let a=e.indexOf("?",8);for(;a!==-1;){const i=e.indexOf("&",a+1);let c=e.indexOf("=",a);c>i&&i!==-1&&(c=-1);let o=e.slice(a+1,c===-1?i===-1?void 0:i:c);if(s&&(o=Re(o)),a=i,o==="")continue;let d;c===-1?d="":(d=e.slice(c+1,i===-1?void 0:i),s&&(d=Re(d))),r?(n[o]&&Array.isArray(n[o])||(n[o]=[]),n[o].push(d)):n[o]??(n[o]=d)}return t?n[t]:n},yr=ct,gr=(e,t)=>ct(e,t,!0),Ee=decodeURIComponent,re,j,et,dt=(et=class{constructor(e,t="/",r=[[]]){p(this,"raw");C(this,re,void 0);C(this,j,void 0);p(this,"routeIndex",0);p(this,"path");p(this,"bodyCache",{});p(this,"cachedBody",e=>{const{bodyCache:t,raw:r}=this,s=t[e];return s||(t.arrayBuffer?(async()=>await new Response(t.arrayBuffer)[e]())():t[e]=r[e]())});this.raw=e,this.path=t,w(this,j,r),w(this,re,{})}param(e){return e?this.getDecodedParam(e):this.getAllDecodedParams()}getDecodedParam(e){const t=f(this,j)[0][this.routeIndex][1][e],r=this.getParamValue(t);return r?/\%/.test(r)?Ee(r):r:void 0}getAllDecodedParams(){const e={},t=Object.keys(f(this,j)[0][this.routeIndex][1]);for(const r of t){const s=this.getParamValue(f(this,j)[0][this.routeIndex][1][r]);s&&typeof s=="string"&&(e[r]=/\%/.test(s)?Ee(s):s)}return e}getParamValue(e){return f(this,j)[1]?f(this,j)[1][e]:e}query(e){return yr(this.url,e)}queries(e){return gr(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;const t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){if(this.bodyCache.parsedBody)return this.bodyCache.parsedBody;const t=await sr(this,e);return this.bodyCache.parsedBody=t,t}json(){return this.cachedBody("json")}text(){return this.cachedBody("text")}arrayBuffer(){return this.cachedBody("arrayBuffer")}blob(){return this.cachedBody("blob")}formData(){return this.cachedBody("formData")}addValidatedData(e,t){f(this,re)[e]=t}valid(e){return f(this,re)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return f(this,j)[0].map(([[,e]])=>e)}get routePath(){return f(this,j)[0].map(([[,e]])=>e)[this.routeIndex].path}},re=new WeakMap,j=new WeakMap,et),R="ALL",br="all",wr=["get","post","put","delete","options","patch"],lt="Can not add a route since the matcher is already built.",ut=class extends Error{},_r=Symbol("composedHandler");function Er(){return class{}}var Sr=e=>e.text("404 Not Found",404),Be=(e,t)=>e instanceof rr?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),D,tt,ht=(tt=class extends Er(){constructor(r={}){super();p(this,"router");p(this,"getPath");p(this,"_basePath","/");C(this,D,"/");p(this,"routes",[]);p(this,"notFoundHandler",Sr);p(this,"errorHandler",Be);p(this,"onError",r=>(this.errorHandler=r,this));p(this,"notFound",r=>(this.notFoundHandler=r,this));p(this,"fetch",(r,s,n)=>this.dispatch(r,n,s,r.method));p(this,"request",(r,s,n,a)=>{if(r instanceof Request)return s!==void 0&&(r=new Request(r,s)),this.fetch(r,n,a);r=r.toString();const i=/^https?:\/\//.test(r)?r:`http://localhost${ie("/",r)}`,c=new Request(i,s);return this.fetch(c,n,a)});p(this,"fire",()=>{addEventListener("fetch",r=>{r.respondWith(this.dispatch(r.request,r,void 0,r.request.method))})});[...wr,br].map(a=>{this[a]=(i,...c)=>(typeof i=="string"?w(this,D,i):this.addRoute(a,f(this,D),i),c.map(o=>{typeof o!="string"&&this.addRoute(a,f(this,D),o)}),this)}),this.on=(a,i,...c)=>{if(!a)return this;for(const o of[i].flat()){w(this,D,o);for(const d of[a].flat())c.map(l=>{this.addRoute(d.toUpperCase(),f(this,D),l)})}return this},this.use=(a,...i)=>(typeof a=="string"?w(this,D,a):(w(this,D,"*"),i.unshift(a)),i.map(c=>{this.addRoute(R,f(this,D),c)}),this);const n=r.strict??!0;delete r.strict,Object.assign(this,r),this.getPath=n?r.getPath??it:mr}clone(){const r=new ht({router:this.router,getPath:this.getPath});return r.routes=this.routes,r}route(r,s){const n=this.basePath(r);return s?(s.routes.map(a=>{let i;s.errorHandler===Be?i=a.handler:(i=async(c,o)=>(await Je([],s.errorHandler)(c,()=>a.handler(c,o))).res,i[_r]=a.handler),n.addRoute(a.method,a.path,i)}),this):n}basePath(r){const s=this.clone();return s._basePath=ie(this._basePath,r),s}mount(r,s,n){const a=ie(this._basePath,r),i=a==="/"?0:a.length,c=async(o,d)=>{let l;try{l=o.executionCtx}catch{}const h=n?n(o):[o.env,l],y=Array.isArray(h)?h:[h],b=pr(o.req.url),m=await s(new Request(new URL((o.req.path.slice(i)||"/")+b,o.req.url),o.req.raw),...y);if(m)return m;await d()};return this.addRoute(R,ie(r,"*"),c),this}addRoute(r,s,n){r=r.toUpperCase(),s=ie(this._basePath,s);const a={path:s,method:r,handler:n};this.router.add(r,s,[n,a]),this.routes.push(a)}matchRoute(r,s){return this.router.match(r,s)}handleError(r,s){if(r instanceof Error)return this.errorHandler(r,s);throw r}dispatch(r,s,n,a){if(a==="HEAD")return(async()=>new Response(null,await this.dispatch(r,s,n,"GET")))();const i=this.getPath(r,{env:n}),c=this.matchRoute(a,i),o=new ge(new dt(r,i,c),{env:n,executionCtx:s,notFoundHandler:this.notFoundHandler});if(c[0].length===1){let l;try{l=c[0][0][0][0](o,async()=>{o.res=await this.notFoundHandler(o)})}catch(h){return this.handleError(h,o)}return l instanceof Promise?l.then(h=>h||(o.finalized?o.res:this.notFoundHandler(o))).catch(h=>this.handleError(h,o)):l}const d=Je(c[0],this.errorHandler,this.notFoundHandler);return(async()=>{try{const l=await d(o);if(!l.finalized)throw new Error("Context is not finalized. You may forget returning Response object or `await next()`");return l.res}catch(l){return this.handleError(l,o)}})()}},D=new WeakMap,tt),Se="[^/]+",ce=".*",de="(?:|/.*)",oe=Symbol(),xr=new Set(".\\+*[^]$()");function vr(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===ce||e===de?1:t===ce||t===de?-1:e===Se?1:t===Se?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var Ie=class{constructor(){p(this,"index");p(this,"varIndex");p(this,"children",Object.create(null))}insert(t,r,s,n,a){if(t.length===0){if(this.index!==void 0)throw oe;if(a)return;this.index=r;return}const[i,...c]=t,o=i==="*"?c.length===0?["","",ce]:["","",Se]:i==="/*"?["","",de]:i.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let d;if(o){const l=o[1];let h=o[2]||Se;if(l&&o[2]&&(h=h.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(h)))throw oe;if(d=this.children[h],!d){if(Object.keys(this.children).some(y=>y!==ce&&y!==de))throw oe;if(a)return;d=this.children[h]=new Ie,l!==""&&(d.varIndex=n.varIndex++)}!a&&l!==""&&s.push([l,d.varIndex])}else if(d=this.children[i],!d){if(Object.keys(this.children).some(l=>l.length>1&&l!==ce&&l!==de))throw oe;if(a)return;d=this.children[i]=new Ie}d.insert(c,r,s,n,a)}buildRegExpStr(){const r=Object.keys(this.children).sort(vr).map(s=>{const n=this.children[s];return(typeof n.varIndex=="number"?`(${s})@${n.varIndex}`:xr.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof this.index=="number"&&r.unshift(`#${this.index}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},Rr=class{constructor(){p(this,"context",{varIndex:0});p(this,"root",new Ie)}insert(e,t,r){const s=[],n=[];for(let i=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,o=>{const d=`@\\${i}`;return n[i]=[d,o],i++,c=!0,d}),!c)break}const a=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=n.length-1;i>=0;i--){const[c]=n[i];for(let o=a.length-1;o>=0;o--)if(a[o].indexOf(c)!==-1){a[o]=a[o].replace(c,n[i][1]);break}}return this.root.insert(a,t,s,this.context,r),s}buildRegExp(){let e=this.root.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,a,i)=>typeof a<"u"?(r[++t]=Number(a),"$()"):(typeof i<"u"&&(s[Number(i)]=++t),"")),[new RegExp(`^${e}`),r,s]}},ft=[],Or=[/^$/,[],Object.create(null)],be=Object.create(null);function pt(e){return be[e]??(be[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*/,"(?:|/.*)")}$`))}function Tr(){be=Object.create(null)}function Pr(e){var d;const t=new Rr,r=[];if(e.length===0)return Or;const s=e.map(l=>[!/\*|\/:/.test(l[0]),...l]).sort(([l,h],[y,b])=>l?1:y?-1:h.length-b.length),n=Object.create(null);for(let l=0,h=-1,y=s.length;l<y;l++){const[b,m,x]=s[l];b?n[m]=[x.map(([v])=>[v,Object.create(null)]),ft]:h++;let O;try{O=t.insert(m,h,b)}catch(v){throw v===oe?new ut(m):v}b||(r[h]=x.map(([v,T])=>{const g=Object.create(null);for(T-=1;T>=0;T--){const[N,A]=O[T];g[N]=A}return[v,g]}))}const[a,i,c]=t.buildRegExp();for(let l=0,h=r.length;l<h;l++)for(let y=0,b=r[l].length;y<b;y++){const m=(d=r[l][y])==null?void 0:d[1];if(!m)continue;const x=Object.keys(m);for(let O=0,v=x.length;O<v;O++)m[x[O]]=c[m[x[O]]]}const o=[];for(const l in i)o[l]=r[i[l]];return[a,o,n]}function te(e,t){if(e){for(const r of Object.keys(e).sort((s,n)=>n.length-s.length))if(pt(r).test(t))return[...e[r]]}}var Ar=class{constructor(){p(this,"name","RegExpRouter");p(this,"middleware");p(this,"routes");this.middleware={[R]:Object.create(null)},this.routes={[R]:Object.create(null)}}add(e,t,r){var c;const{middleware:s,routes:n}=this;if(!s||!n)throw new Error(lt);s[e]||[s,n].forEach(o=>{o[e]=Object.create(null),Object.keys(o[R]).forEach(d=>{o[e][d]=[...o[R][d]]})}),t==="/*"&&(t="*");const a=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const o=pt(t);e===R?Object.keys(s).forEach(d=>{var l;(l=s[d])[t]||(l[t]=te(s[d],t)||te(s[R],t)||[])}):(c=s[e])[t]||(c[t]=te(s[e],t)||te(s[R],t)||[]),Object.keys(s).forEach(d=>{(e===R||e===d)&&Object.keys(s[d]).forEach(l=>{o.test(l)&&s[d][l].push([r,a])})}),Object.keys(n).forEach(d=>{(e===R||e===d)&&Object.keys(n[d]).forEach(l=>o.test(l)&&n[d][l].push([r,a]))});return}const i=ot(t)||[t];for(let o=0,d=i.length;o<d;o++){const l=i[o];Object.keys(n).forEach(h=>{var y;(e===R||e===h)&&((y=n[h])[l]||(y[l]=[...te(s[h],l)||te(s[R],l)||[]]),n[h][l].push([r,a-d+o+1]))})}}match(e,t){Tr();const r=this.buildAllMatchers();return this.match=(s,n)=>{const a=r[s]||r[R],i=a[2][n];if(i)return i;const c=n.match(a[0]);if(!c)return[[],ft];const o=c.indexOf("",1);return[a[1][o],c]},this.match(e,t)}buildAllMatchers(){const e=Object.create(null);return[...Object.keys(this.routes),...Object.keys(this.middleware)].forEach(t=>{e[t]||(e[t]=this.buildMatcher(t))}),this.middleware=this.routes=void 0,e}buildMatcher(e){const t=[];let r=e===R;return[this.middleware,this.routes].forEach(s=>{const n=s[e]?Object.keys(s[e]).map(a=>[a,s[e][a]]):[];n.length!==0?(r||(r=!0),t.push(...n)):e!==R&&t.push(...Object.keys(s[R]).map(a=>[a,s[R][a]]))}),r?Pr(t):null}},Hr=class{constructor(e){p(this,"name","SmartRouter");p(this,"routers",[]);p(this,"routes",[]);Object.assign(this,e)}add(e,t,r){if(!this.routes)throw new Error(lt);this.routes.push([e,t,r])}match(e,t){if(!this.routes)throw new Error("Fatal error");const{routers:r,routes:s}=this,n=r.length;let a=0,i;for(;a<n;a++){const c=r[a];try{s.forEach(o=>{c.add(...o)}),i=c.match(e,t)}catch(o){if(o instanceof ut)continue;throw o}this.match=c.match.bind(c),this.routers=[c],this.routes=void 0;break}if(a===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.routes||this.routers.length!==1)throw new Error("No active router has been determined yet.");return this.routers[0]}},mt=class{constructor(e,t,r){p(this,"methods");p(this,"children");p(this,"patterns");p(this,"order",0);p(this,"name");p(this,"params",Object.create(null));if(this.children=r||Object.create(null),this.methods=[],this.name="",e&&t){const s=Object.create(null);s[e]={handler:t,possibleKeys:[],score:0,name:this.name},this.methods=[s]}this.patterns=[]}insert(e,t,r){this.name=`${e} ${t}`,this.order=++this.order;let s=this;const n=ur(t),a=[],i=[];for(let d=0,l=n.length;d<l;d++){const h=n[d];if(Object.keys(s.children).includes(h)){i.push(...s.patterns),s=s.children[h];const b=Ke(h);b&&a.push(b[1]);continue}s.children[h]=new mt;const y=Ke(h);y&&(s.patterns.push(y),i.push(...s.patterns),a.push(y[1])),i.push(...s.patterns),s=s.children[h]}s.methods.length||(s.methods=[]);const c=Object.create(null),o={handler:r,possibleKeys:a.filter((d,l,h)=>h.indexOf(d)===l),name:this.name,score:this.order};return c[e]=o,s.methods.push(c),s}gHSets(e,t,r,s){const n=[];for(let a=0,i=e.methods.length;a<i;a++){const c=e.methods[a],o=c[t]||c[R],d=Object.create(null);o!==void 0&&(o.params=Object.create(null),o.possibleKeys.forEach(l=>{const h=d[o.name];o.params[l]=s[l]&&!h?s[l]:r[l]??s[l],d[o.name]=!0}),n.push(o))}return n}search(e,t){const r=[];this.params=Object.create(null);let n=[this];const a=at(t);for(let c=0,o=a.length;c<o;c++){const d=a[c],l=c===o-1,h=[];for(let y=0,b=n.length;y<b;y++){const m=n[y],x=m.children[d];x&&(x.params=m.params,l===!0?(x.children["*"]&&r.push(...this.gHSets(x.children["*"],e,m.params,Object.create(null))),r.push(...this.gHSets(x,e,m.params,Object.create(null)))):h.push(x));for(let O=0,v=m.patterns.length;O<v;O++){const T=m.patterns[O],g={...m.params};if(T==="*"){const H=m.children["*"];H&&(r.push(...this.gHSets(H,e,m.params,Object.create(null))),h.push(H));continue}if(d==="")continue;const[N,A,F]=T,P=m.children[N],J=a.slice(c).join("/");if(F instanceof RegExp&&F.test(J)){g[A]=J,r.push(...this.gHSets(P,e,m.params,g));continue}(F===!0||F instanceof RegExp&&F.test(d))&&typeof N=="string"&&(g[A]=d,l===!0?(r.push(...this.gHSets(P,e,g,m.params)),P.children["*"]&&r.push(...this.gHSets(P.children["*"],e,g,m.params))):(P.params=g,h.push(P)))}}n=h}return[r.sort((c,o)=>c.score-o.score).map(({handler:c,params:o})=>[c,o])]}},Ir=class{constructor(){p(this,"name","TrieRouter");p(this,"node");this.node=new mt}add(e,t,r){const s=ot(t);if(s){for(const n of s)this.node.insert(e,n,r);return}this.node.insert(e,t,r)}match(e,t){return this.node.search(e,t)}},qe=class extends ht{constructor(e={}){super(e),this.router=e.router??new Hr({routers:[new Ar,new Ir]})}},jr=class{constructor(){p(this,"createMiddleware",e=>e)}createHandlers(...e){return e.filter(t=>t!==void 0)}},yt=()=>new jr,Dr=e=>yt().createMiddleware(e);const Cr=yt(),ne=Cr.createHandlers;var $r=/^[\w!#$%&'*.^`|~+-]+$/,Lr=/^[ !#-:<-[\]-~]*$/,ze=(e,t)=>e.trim().split(";").reduce((s,n)=>{n=n.trim();const a=n.indexOf("=");if(a===-1)return s;const i=n.substring(0,a).trim();if(t&&t!==i||!$r.test(i))return s;let c=n.substring(a+1).trim();return c.startsWith('"')&&c.endsWith('"')&&(c=c.slice(1,-1)),Lr.test(c)&&(s[i]=Ee(c)),s},{}),kr=(e,t,r={})=>{let s=`${e}=${t}`;if(e.startsWith("__Secure-")&&!r.secure)throw new Error("__Secure- Cookie must have Secure attributes");if(e.startsWith("__Host-")){if(!r.secure)throw new Error("__Host- Cookie must have Secure attributes");if(r.path!=="/")throw new Error('__Host- Cookie must have Path attributes with "/"');if(r.domain)throw new Error("__Host- Cookie must not have Domain attributes")}if(r&&typeof r.maxAge=="number"&&r.maxAge>=0){if(r.maxAge>3456e4)throw new Error("Cookies Max-Age SHOULD NOT be greater than 400 days (34560000 seconds) in duration.");s+=`; Max-Age=${Math.floor(r.maxAge)}`}if(r.domain&&r.prefix!=="host"&&(s+=`; Domain=${r.domain}`),r.path&&(s+=`; Path=${r.path}`),r.expires){if(r.expires.getTime()-Date.now()>3456e7)throw new Error("Cookies Expires SHOULD NOT be greater than 400 days (34560000 seconds) in the future.");s+=`; Expires=${r.expires.toUTCString()}`}if(r.httpOnly&&(s+="; HttpOnly"),r.secure&&(s+="; Secure"),r.sameSite&&(s+=`; SameSite=${r.sameSite}`),r.partitioned){if(!r.secure)throw new Error("Partitioned Cookie must have Secure attributes");s+="; Partitioned"}return s},Oe=(e,t,r)=>(t=encodeURIComponent(t),kr(e,t,r)),he=(e,t,r)=>{const s=e.req.raw.headers.get("Cookie");if(typeof t=="string"){if(!s)return;let a=t;return r==="secure"?a="__Secure-"+t:r==="host"&&(a="__Host-"+t),ze(s,a)[a]}return s?ze(s):{}},le=(e,t,r,s)=>{let n;(s==null?void 0:s.prefix)==="secure"?n=Oe("__Secure-"+t,r,{path:"/",...s,secure:!0}):(s==null?void 0:s.prefix)==="host"?n=Oe("__Host-"+t,r,{...s,path:"/",secure:!0,domain:void 0}):n=Oe(t,r,{path:"/",...s}),e.header("set-cookie",n,{append:!0})},Nr=(e,t,r)=>{le(e,t,"",{...r,maxAge:0})},q=(e=>(e.session="session",e.siteUrl="site_url",e.secretMaster="secret_master_key",e.SignedParams="signed_params",e))(q||{}),fe=(e=>(e.login="/login",e.credentials="/credentials",e.home="/",e))(fe||{});function Mr(e){const t=he(e,"signed_params");if(!t)return{};try{return JSON.parse(t,(r,s)=>typeof s=="string"&&!isNaN(Number(s))?Number(s):s)}catch{return{}}}function De(e){const t=he(e,"site_url"),r=he(e,"secret_master_key"),s=Mr(e);return{siteUrl:t,secretKey:r,signedParams:s}}function Ce({context:e,redirectIfOk:t}){const r=he(e,"session"),s=e.req.query("edit")==="1",n=e.req.path,a=s&&n==="/credentials";if(!r)return"/login";const{siteUrl:i,secretKey:c}=De(e);if(!i||!c||a)return"/credentials";if(t)return"/"}function $e({isLogin:e}){return u("header",{class:"flex items-center justify-between",children:[u("a",{href:"/",class:"-m-1.5 p-1.5",children:[u("span",{class:"sr-only",children:"Latitude example"}),u("img",{class:"h-8 w-auto",src:"https://cdn.sanity.io/images/n7wdrkrw/production/b30fe3307a21c83de2a955880ee614aa16e60248-79x15.svg",alt:"Latitude Example"})]}),e&&u("div",{class:"flex gap-x-3 items-center",children:[u("a",{href:`${fe.credentials}?edit=1`,class:"text-blue-500 underline",children:"Edit credentials"}),u("form",{action:"/logout",method:"POST",children:u(st,{type:"submit",children:"Logout"})})]})]})}const Wr=ne(async e=>{if(!he(e,"session"))return e.redirect("/login");const r=await e.req.parseBody(),s=r[q.siteUrl],n=r[q.secretMaster],a=r["signed_keys[]"]||[],i=r["signed_values[]"],c=Array.isArray(a)?a:[a],o=Array.isArray(i)?i:[i],d=c.reduce((l,h,y)=>(l[h]=o[y],l),{});return!s||!n?e.redirect("/credentials?error=1"):(le(e,q.siteUrl,s),le(e,q.secretMaster,n),le(e,q.SignedParams,JSON.stringify(d)),e.redirect("/"))}),Ur=ne(e=>{const t=e.req.query("error"),r=Ce({context:e,redirectIfOk:!0});if(r&&r!==fe.credentials)return e.redirect(r);const{siteUrl:s,secretKey:n,signedParams:a}=De(e);return e.render(u(Z,{children:[u($e,{isLogin:!0}),u("div",{class:"flex flex-col items-center justify-center px-6 py-8 mx-auto md:h-screen lg:py-0",children:u("div",{class:"w-full bg-white rounded-lg shadow dark:border md:mt-0 sm:max-w-3xl xl:p-0 dark:bg-gray-800 dark:border-gray-700",children:u("div",{class:"p-6 space-y-4 md:space-y-6 sm:p-8",children:[u("h1",{class:"text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white",children:"Set your Latitude credentials"}),t&&u("div",{children:u("p",{class:"text-sm font-medium text-red-500 dark:text-red-400",children:"Wrong site URL or secret master key. Please define both"})}),u("form",{class:"space-y-6",method:"POST",children:[u(Fe,{required:!0,name:q.siteUrl,label:"Site URL",value:s,placeholder:"Ex.: http://localhost:3000"}),u(Fe,{required:!0,name:q.secretMaster,label:"Site URL",value:n,placeholder:"Put your LATITUDE_MASTER_KEY"}),u("div",{children:u(Kt,{signedParams:a})}),u(st,{type:"submit",children:"Store credentials"})]})]})})})]}))}),Fr=Object.freeze(Object.defineProperty({__proto__:null,POST:Wr,default:Ur},Symbol.toStringTag,{value:"Module"})),Le=crypto,gt=e=>e instanceof CryptoKey,k=new TextEncoder,se=new TextDecoder;function bt(...e){const t=e.reduce((n,{length:a})=>n+a,0),r=new Uint8Array(t);let s=0;for(const n of e)r.set(n,s),s+=n.length;return r}const Jr=e=>{let t=e;typeof t=="string"&&(t=k.encode(t));const r=32768,s=[];for(let n=0;n<t.length;n+=r)s.push(String.fromCharCode.apply(null,t.subarray(n,n+r)));return btoa(s.join(""))},Te=e=>Jr(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),Kr=e=>{const t=atob(e),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r},Pe=e=>{let t=e;t instanceof Uint8Array&&(t=se.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return Kr(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class ee extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(t){var r;super(t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(r=Error.captureStackTrace)==null||r.call(Error,this,this.constructor)}}class $ extends ee{static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}constructor(t,r="unspecified",s="unspecified"){super(t),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=s}}class Ve extends ee{static get code(){return"ERR_JWT_EXPIRED"}constructor(t,r="unspecified",s="unspecified"){super(t),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=s}}class Br extends ee{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class wt extends ee{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class E extends ee{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class ke extends ee{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class qr extends ee{constructor(){super(...arguments),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}function M(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function ye(e,t){return e.name===t}function Ae(e){return parseInt(e.name.slice(4),10)}function zr(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function Vr(e,t){if(t.length&&!t.some(r=>e.usages.includes(r))){let r="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const s=t.pop();r+=`one of ${t.join(", ")}, or ${s}.`}else t.length===2?r+=`one of ${t[0]} or ${t[1]}.`:r+=`${t[0]}.`;throw new TypeError(r)}}function Gr(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!ye(e.algorithm,"HMAC"))throw M("HMAC");const s=parseInt(t.slice(2),10);if(Ae(e.algorithm.hash)!==s)throw M(`SHA-${s}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!ye(e.algorithm,"RSASSA-PKCS1-v1_5"))throw M("RSASSA-PKCS1-v1_5");const s=parseInt(t.slice(2),10);if(Ae(e.algorithm.hash)!==s)throw M(`SHA-${s}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!ye(e.algorithm,"RSA-PSS"))throw M("RSA-PSS");const s=parseInt(t.slice(2),10);if(Ae(e.algorithm.hash)!==s)throw M(`SHA-${s}`,"algorithm.hash");break}case"EdDSA":{if(e.algorithm.name!=="Ed25519"&&e.algorithm.name!=="Ed448")throw M("Ed25519 or Ed448");break}case"ES256":case"ES384":case"ES512":{if(!ye(e.algorithm,"ECDSA"))throw M("ECDSA");const s=zr(t);if(e.algorithm.namedCurve!==s)throw M(s,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}Vr(e,r)}function _t(e,t,...r){var s;if(r.length>2){const n=r.pop();e+=`one of type ${r.join(", ")}, or ${n}.`}else r.length===2?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&(s=t.constructor)!=null&&s.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const Ge=(e,...t)=>_t("Key must be ",e,...t);function Et(e,t,...r){return _t(`Key for the ${e} algorithm must be `,t,...r)}const St=e=>gt(e),L=["CryptoKey"],xt=(...e)=>{const t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let r;for(const s of t){const n=Object.keys(s);if(!r||r.size===0){r=new Set(n);continue}for(const a of n){if(r.has(a))return!1;r.add(a)}}return!0};function Xr(e){return typeof e=="object"&&e!==null}function xe(e){if(!Xr(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}const vt=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if(typeof r!="number"||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}},Yr=(e,t)=>{if(!(t instanceof Uint8Array)){if(!St(t))throw new TypeError(Et(e,t,...L,"Uint8Array"));if(t.type!=="secret")throw new TypeError(`${L.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}},Qr=(e,t,r)=>{if(!St(t))throw new TypeError(Et(e,t,...L));if(t.type==="secret")throw new TypeError(`${L.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if(r==="sign"&&t.type==="public")throw new TypeError(`${L.join(" or ")} instances for asymmetric algorithm signing must be of type "private"`);if(r==="decrypt"&&t.type==="public")throw new TypeError(`${L.join(" or ")} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&r==="verify"&&t.type==="private")throw new TypeError(`${L.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&r==="encrypt"&&t.type==="private")throw new TypeError(`${L.join(" or ")} instances for asymmetric algorithm encryption must be of type "public"`)},Rt=(e,t,r)=>{e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?Yr(e,t):Qr(e,t,r)};function Ot(e,t,r,s,n){if(n.crit!==void 0&&(s==null?void 0:s.crit)===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!s||s.crit===void 0)return new Set;if(!Array.isArray(s.crit)||s.crit.length===0||s.crit.some(i=>typeof i!="string"||i.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let a;r!==void 0?a=new Map([...Object.entries(r),...t.entries()]):a=t;for(const i of s.crit){if(!a.has(i))throw new wt(`Extension Header Parameter "${i}" is not recognized`);if(n[i]===void 0)throw new e(`Extension Header Parameter "${i}" is missing`);if(a.get(i)&&s[i]===void 0)throw new e(`Extension Header Parameter "${i}" MUST be integrity protected`)}return new Set(s.crit)}const Zr=(e,t)=>{if(t!==void 0&&(!Array.isArray(t)||t.some(r=>typeof r!="string")))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};function Tt(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"EdDSA":return{name:t.name};default:throw new wt(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}function Pt(e,t,r){if(gt(t))return Gr(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(Ge(t,...L));return Le.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(Ge(t,...L,"Uint8Array"))}const es=async(e,t,r,s)=>{const n=await Pt(e,t,"verify");vt(e,n);const a=Tt(e,n.algorithm);try{return await Le.subtle.verify(a,n,r,s)}catch{return!1}};async function ts(e,t,r){if(!xe(e))throw new E("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new E('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new E("JWS Protected Header incorrect type");if(e.payload===void 0)throw new E("JWS Payload missing");if(typeof e.signature!="string")throw new E("JWS Signature missing or incorrect type");if(e.header!==void 0&&!xe(e.header))throw new E("JWS Unprotected Header incorrect type");let s={};if(e.protected)try{const x=Pe(e.protected);s=JSON.parse(se.decode(x))}catch{throw new E("JWS Protected Header is invalid")}if(!xt(s,e.header))throw new E("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...s,...e.header},a=Ot(E,new Map([["b64",!0]]),r==null?void 0:r.crit,s,n);let i=!0;if(a.has("b64")&&(i=s.b64,typeof i!="boolean"))throw new E('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:c}=n;if(typeof c!="string"||!c)throw new E('JWS "alg" (Algorithm) Header Parameter missing or invalid');const o=r&&Zr("algorithms",r.algorithms);if(o&&!o.has(c))throw new Br('"alg" (Algorithm) Header Parameter value not allowed');if(i){if(typeof e.payload!="string")throw new E("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new E("JWS Payload must be a string or an Uint8Array instance");let d=!1;typeof t=="function"&&(t=await t(s,e),d=!0),Rt(c,t,"verify");const l=bt(k.encode(e.protected??""),k.encode("."),typeof e.payload=="string"?k.encode(e.payload):e.payload);let h;try{h=Pe(e.signature)}catch{throw new E("Failed to base64url decode the signature")}if(!await es(c,t,h,l))throw new qr;let b;if(i)try{b=Pe(e.payload)}catch{throw new E("Failed to base64url decode the payload")}else typeof e.payload=="string"?b=k.encode(e.payload):b=e.payload;const m={payload:b};return e.protected!==void 0&&(m.protectedHeader=s),e.header!==void 0&&(m.unprotectedHeader=e.header),d?{...m,key:t}:m}async function rs(e,t,r){if(e instanceof Uint8Array&&(e=se.decode(e)),typeof e!="string")throw new E("Compact JWS must be a string or Uint8Array");const{0:s,1:n,2:a,length:i}=e.split(".");if(i!==3)throw new E("Invalid Compact JWS");const c=await ts({payload:n,protected:s,signature:a},t,r),o={payload:c.payload,protectedHeader:c.protectedHeader};return typeof t=="function"?{...o,key:c.key}:o}const B=e=>Math.floor(e.getTime()/1e3),At=60,Ht=At*60,Ne=Ht*24,ss=Ne*7,ns=Ne*365.25,as=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,ue=e=>{const t=as.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]),s=t[3].toLowerCase();let n;switch(s){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(r*At);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(r*Ht);break;case"day":case"days":case"d":n=Math.round(r*Ne);break;case"week":case"weeks":case"w":n=Math.round(r*ss);break;default:n=Math.round(r*ns);break}return t[1]==="-"||t[4]==="ago"?-n:n},Xe=e=>e.toLowerCase().replace(/^application\//,""),is=(e,t)=>typeof e=="string"?t.includes(e):Array.isArray(e)?t.some(Set.prototype.has.bind(new Set(e))):!1,os=(e,t,r={})=>{const{typ:s}=r;if(s&&(typeof e.typ!="string"||Xe(e.typ)!==Xe(s)))throw new $('unexpected "typ" JWT header value',"typ","check_failed");let n;try{n=JSON.parse(se.decode(t))}catch{}if(!xe(n))throw new ke("JWT Claims Set must be a top-level JSON object");const{requiredClaims:a=[],issuer:i,subject:c,audience:o,maxTokenAge:d}=r,l=[...a];d!==void 0&&l.push("iat"),o!==void 0&&l.push("aud"),c!==void 0&&l.push("sub"),i!==void 0&&l.push("iss");for(const m of new Set(l.reverse()))if(!(m in n))throw new $(`missing required "${m}" claim`,m,"missing");if(i&&!(Array.isArray(i)?i:[i]).includes(n.iss))throw new $('unexpected "iss" claim value',"iss","check_failed");if(c&&n.sub!==c)throw new $('unexpected "sub" claim value',"sub","check_failed");if(o&&!is(n.aud,typeof o=="string"?[o]:o))throw new $('unexpected "aud" claim value',"aud","check_failed");let h;switch(typeof r.clockTolerance){case"string":h=ue(r.clockTolerance);break;case"number":h=r.clockTolerance;break;case"undefined":h=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:y}=r,b=B(y||new Date);if((n.iat!==void 0||d)&&typeof n.iat!="number")throw new $('"iat" claim must be a number',"iat","invalid");if(n.nbf!==void 0){if(typeof n.nbf!="number")throw new $('"nbf" claim must be a number',"nbf","invalid");if(n.nbf>b+h)throw new $('"nbf" claim timestamp check failed',"nbf","check_failed")}if(n.exp!==void 0){if(typeof n.exp!="number")throw new $('"exp" claim must be a number',"exp","invalid");if(n.exp<=b-h)throw new Ve('"exp" claim timestamp check failed',"exp","check_failed")}if(d){const m=b-n.iat,x=typeof d=="number"?d:ue(d);if(m-h>x)throw new Ve('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(m<0-h)throw new $('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return n};async function cs(e,t,r){var i;const s=await rs(e,t,r);if((i=s.protectedHeader.crit)!=null&&i.includes("b64")&&s.protectedHeader.b64===!1)throw new ke("JWTs MUST NOT use unencoded payload");const a={payload:os(s.protectedHeader,s.payload,r),protectedHeader:s.protectedHeader};return typeof t=="function"?{...a,key:s.key}:a}const ds=async(e,t,r)=>{const s=await Pt(e,t,"sign");vt(e,s);const n=await Le.subtle.sign(Tt(e,s.algorithm),s,r);return new Uint8Array(n)};class ls{constructor(t){if(!(t instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=t}setProtectedHeader(t){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=t,this}setUnprotectedHeader(t){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=t,this}async sign(t,r){if(!this._protectedHeader&&!this._unprotectedHeader)throw new E("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!xt(this._protectedHeader,this._unprotectedHeader))throw new E("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const s={...this._protectedHeader,...this._unprotectedHeader},n=Ot(E,new Map([["b64",!0]]),r==null?void 0:r.crit,this._protectedHeader,s);let a=!0;if(n.has("b64")&&(a=this._protectedHeader.b64,typeof a!="boolean"))throw new E('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:i}=s;if(typeof i!="string"||!i)throw new E('JWS "alg" (Algorithm) Header Parameter missing or invalid');Rt(i,t,"sign");let c=this._payload;a&&(c=k.encode(Te(c)));let o;this._protectedHeader?o=k.encode(Te(JSON.stringify(this._protectedHeader))):o=k.encode("");const d=bt(o,k.encode("."),c),l=await ds(i,t,d),h={signature:Te(l),payload:""};return a&&(h.payload=se.decode(c)),this._unprotectedHeader&&(h.header=this._unprotectedHeader),this._protectedHeader&&(h.protected=se.decode(o)),h}}class us{constructor(t){this._flattened=new ls(t)}setProtectedHeader(t){return this._flattened.setProtectedHeader(t),this}async sign(t,r){const s=await this._flattened.sign(t,r);if(s.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${s.protected}.${s.payload}.${s.signature}`}}function Y(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}class hs{constructor(t={}){if(!xe(t))throw new TypeError("JWT Claims Set MUST be an object");this._payload=t}setIssuer(t){return this._payload={...this._payload,iss:t},this}setSubject(t){return this._payload={...this._payload,sub:t},this}setAudience(t){return this._payload={...this._payload,aud:t},this}setJti(t){return this._payload={...this._payload,jti:t},this}setNotBefore(t){return typeof t=="number"?this._payload={...this._payload,nbf:Y("setNotBefore",t)}:t instanceof Date?this._payload={...this._payload,nbf:Y("setNotBefore",B(t))}:this._payload={...this._payload,nbf:B(new Date)+ue(t)},this}setExpirationTime(t){return typeof t=="number"?this._payload={...this._payload,exp:Y("setExpirationTime",t)}:t instanceof Date?this._payload={...this._payload,exp:Y("setExpirationTime",B(t))}:this._payload={...this._payload,exp:B(new Date)+ue(t)},this}setIssuedAt(t){return typeof t>"u"?this._payload={...this._payload,iat:B(new Date)}:t instanceof Date?this._payload={...this._payload,iat:Y("setIssuedAt",B(t))}:typeof t=="string"?this._payload={...this._payload,iat:Y("setIssuedAt",B(new Date)+ue(t))}:this._payload={...this._payload,iat:Y("setIssuedAt",t)},this}}class fs extends hs{setProtectedHeader(t){return this._protectedHeader=t,this}async sign(t,r){var n;const s=new us(k.encode(JSON.stringify(this._payload)));if(s.setProtectedHeader(this._protectedHeader),Array.isArray((n=this._protectedHeader)==null?void 0:n.crit)&&this._protectedHeader.crit.includes("b64")&&this._protectedHeader.b64===!1)throw new ke("JWTs MUST NOT use unencoded payload");return s.sign(t,r)}}const It="HS256";function jt(e){return new TextEncoder().encode(e)}async function ps({payload:e,secretKey:t,expirationTime:r="2h"}){try{const s=jt(t);return await new fs(e).setProtectedHeader({alg:It}).setIssuedAt().setExpirationTime(r).sign(s)}catch(s){return s}}const ms=["iss","sub","aud","jti","nbf","exp","iat"];function ys(e){return Object.keys(e).reduce((t,r)=>(ms.includes(r)?t.metadata[r]=e[r]:t.payload[r]=e[r],t),{metadata:{},payload:{}})}async function gs({secretKey:e,token:t}){try{const r=jt(e),{payload:s,protectedHeader:n}=await cs(t,r,{algorithms:[It]}),{payload:a,metadata:i}=ys(s);return{payload:a,metadata:i,protectedHeader:n}}catch(r){return r}}function we({label:e,children:t}){return u("div",{children:[u("span",{class:"font-semibold",children:e}),":",u("div",{className:"font-mono max-w-full truncate text-sm text-gray-600",children:t})]})}function Dt({children:e}){return u("div",{class:"bg-blue-50 border border-blue-100 p-4 rounded-lg flex flex-col gap-y-4",children:e})}function bs({siteUrl:e,masterKey:t,tokenData:r}){return u(Dt,{children:[u("h1",{class:"text-xl font-medium",children:"Credentials"}),u("div",{class:"flex flex-col gap-y-2",children:[u(we,{label:"Latitude Data URL",children:e}),u(we,{label:"Master Key",children:t}),u(we,{label:"Signed params",children:JSON.stringify(r.payload)})]})]})}const ws=ne(async e=>{const t=Ce({context:e,redirectIfOk:!1});if(t)return e.redirect(t);const{siteUrl:r,secretKey:s,signedParams:n}=De(e),a=s,i=await ps({secretKey:a,payload:n});if(i instanceof Error)return e.render(i.message);const c=await gs({secretKey:a,token:i});return c instanceof Error?e.render(c.message):e.render(u(Z,{children:[u($e,{isLogin:!0}),u("div",{class:"mt-10 flex flex-col gap-y-4",children:[u(bs,{siteUrl:r,masterKey:a,tokenData:c}),u(Dt,{children:u(we,{label:"Generated [TOKEN]",children:i})}),u(Jt,{siteUrl:r,token:i})]})]}))}),_s=Object.freeze(Object.defineProperty({__proto__:null,default:ws},Symbol.toStringTag,{value:"Module"})),_e="latitude",je="latitude_secret",Es=ne(async e=>{const{username:t,password:r}=await e.req.parseBody();return t!==_e||r!==je?e.redirect("/login?error=1"):(le(e,"session","1"),e.redirect(fe.home))}),Ss=ne(e=>{const t=e.req.query("error"),r=Ce({context:e,redirectIfOk:!0});return r&&r!==fe.login?e.redirect(r):e.render(u(Z,{children:[u($e,{isLogin:!1}),u("div",{class:"flex flex-col items-center justify-center px-6 py-8 mx-auto md:h-screen lg:py-0",children:u("div",{class:"w-full bg-white rounded-lg shadow dark:border md:mt-0 sm:max-w-md xl:p-0 dark:bg-gray-800 dark:border-gray-700",children:u("div",{class:"p-6 space-y-4 md:space-y-6 sm:p-8",children:[u("h1",{class:"text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white",children:"My secret Dashboard"}),t&&u("div",{children:[u("p",{class:"text-sm font-medium text-red-500 dark:text-red-400",children:"Wrong username or password"}),u("p",{class:"text-sm font-medium text-red-500 dark:text-red-400",children:["Psss use ",u("strong",{children:_e})," as username and"," ",u("strong",{children:je})," as password"]})]}),u("form",{class:"space-y-4 md:space-y-6",method:"POST",children:[u("div",{children:[u("label",{for:"username",class:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Username"}),u("input",{type:"text",name:"username",id:"username",class:"bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500",placeholder:_e,required:!0})]}),u("div",{children:[u("label",{for:"password",class:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Password"}),u("input",{type:"password",name:"password",id:"password",placeholder:"••••••••",class:"bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500",required:!0})]}),u("button",{type:"submit",class:"w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-primary-800",children:"Login"}),u("p",{class:"text-lg font-light text-gray-600 dark:text-gray-400",children:["Easy, use ",u("strong",{class:"text-blue-500",children:_e})," as username and"," ",u("strong",{class:"text-blue-500",children:je})," as password"]})]})]})})})]}))}),xs=Object.freeze(Object.defineProperty({__proto__:null,POST:Es,default:Ss},Symbol.toStringTag,{value:"Module"})),vs=ne(async e=>(Nr(e,"session"),e.redirect("/login"))),Rs=Object.freeze(Object.defineProperty({__proto__:null,POST:vs},Symbol.toStringTag,{value:"Module"})),Ye=e=>(e=e.replace(/\.tsx?$/g,"").replace(/\.mdx$/g,"").replace(/^\/?index$/,"/").replace(/\/index$/,"").replace(/\[\.{3}.+\]/,"*").replace(/\[(.+?)\]/g,":$1"),/^\//.test(e)?e:"/"+e),He=e=>{const t={};for(const[r,s]of Object.entries(e)){const n=r.split("/"),a=n.pop(),i=n.join("/");t[i]||(t[i]={}),a&&(t[i][a]=s)}for(const[r,s]of Object.entries(t)){const n=Object.entries(s).sort(([a],[i])=>a[0]==="["&&i[0]!=="["?1:a[0]!=="["&&i[0]==="["?-1:a.localeCompare(i));t[r]=Object.fromEntries(n)}return t},Os=e=>Object.keys(e).sort((s,n)=>{const a=s.split("/").length;return n.split("/").length-a}).map(s=>({[s]:e[s]})),Qe=e=>{const t={};for(const s of Object.keys(e)){const n=s.split("/");n.pop();const a=n.join("/");t[a]||(t[a]=[]),t[a].includes(s)||t[a].push(s)}const r=Object.keys(t).sort((s,n)=>n.length-s.length);for(const s of r)for(const n of r)if(n.startsWith(s)&&n!==s){const a=new Set([...t[n],...t[s]]);t[n]=[...a]}return t},Ts="_404.tsx",Ps="_error.tsx",As=["GET","POST","PUT","DELETE","OPTIONS","PATCH"],Hs=e=>{const t=e.root,r=new RegExp(`^${t}`),s=e.app??new qe,n=e.trailingSlash??!1;e.init&&e.init(s);const a=e.NOT_FOUND,i=He(a),c=e.ERROR,o=He(c),d=e.RENDERER,l=Qe(d),h=e.MIDDLEWARE,y=Qe(h),b=e.ROUTES,m=Os(He(b)),x=(O,v)=>{let T=v[O]??[];const g=A=>(T=v[A.join("/")],T||(A.pop(),A.length&&g(A)),T??[]),N=O.split("/");return T=g(N),T.sort((A,F)=>A.split("/").length-F.split("/").length),T};for(const O of m)for(const[v,T]of Object.entries(O)){const g=new qe;let N=!1;x(v,l).map(J=>{const H=d[J];H[z]&&(N=!0);const V=H.default;V&&g.all("*",V)}),x(v,y).map(J=>{const ae=h[J].default;ae&&g.use(...ae)});let P=v.replace(r,"");P=Ye(P);for(const[J,H]of Object.entries(T)){const ae=H[z],V=Dr(async function(pe,Ct){pe.set(z,ae?!0:N),await Ct()}),K=H.default,G=Ye(J);K&&"fetch"in K&&(g.use(V),g.route(G,K));for(const X of As){const pe=H[X];pe&&(g.on(X,G,V),g.on(X,G,...pe))}K&&Array.isArray(K)&&(g.get(G,V),g.get(G,...K)),typeof K=="function"&&(g.get(G,V),g.get(G,X=>X.render(K(X),H)))}Is(g,v,i),js(g,v,o),n&&(P=/\/$/.test(P)?P:P+"/"),s.route(P,g)}return s};function Is(e,t,r){for(const[s,n]of Object.entries(r))if(t===s){const a=n[Ts];if(a){const i=a.default;a[z]&&e.use("*",(o,d)=>(o.set(z,!0),d())),e.get("*",o=>(o.status(404),i(o)))}}}function js(e,t,r){for(const[s,n]of Object.entries(r))if(t===s){const a=n[Ps];if(a){const i=a.default;e.onError(async(c,o)=>{const d=a[z];return d&&o.set(z,d),o.status(500),i(c,o)})}}}const Ds=e=>{const t={root:(e==null?void 0:e.root)??"/app/routes",app:e==null?void 0:e.app,init:e==null?void 0:e.init,trailingSlash:e==null?void 0:e.trailingSlash,NOT_FOUND:(e==null?void 0:e.NOT_FOUND)??Object.assign({"/app/routes/_404.tsx":zt}),ERROR:(e==null?void 0:e.ERROR)??Object.assign({"/app/routes/_error.tsx":Gt}),RENDERER:(e==null?void 0:e.RENDERER)??Object.assign({"/app/routes/_renderer.tsx":er}),MIDDLEWARE:(e==null?void 0:e.MIDDLEWARE)??Object.assign({}),ROUTES:(e==null?void 0:e.ROUTES)??Object.assign({"/app/routes/credentials.tsx":Fr,"/app/routes/index.tsx":_s,"/app/routes/login.tsx":xs,"/app/routes/logout.tsx":Rs})};return Hs(t)},Cs=({children:e})=>{const t=Qt();return u(Z,{children:t.get(z)?e:u(Z,{})})},$s=async e=>{const t=e.src;if(e.prod??!0){let r=e.manifest;if(!r){const s=Object.assign({});for(const[,n]of Object.entries(s))if(n.default){r=n.default;break}}if(r){const s=r[t.replace(/^\//,"")];if(s)return u(Cs,{children:u("script",{type:"module",async:!!e.async,src:`/${s.file}`})})}return u(Z,{})}else return u("script",{type:"module",async:!!e.async,src:t})};Ds();
